
<!DOCTYPE html>
<html>
<head>
	<title>Login</title>
	<meta name="Description" content="Practica 4 PAT para login">
	<meta charset="utf-8">
	<meta lang="es">

	<!--Link necesario para el css de bootstrap-->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">

	<style type="text/css">
		
		.estancoColors{
			background-color: #8B0000;
		}
	</style>

</head>
<body>

	<header class="container-fluid estancoColors py-5">

		<div class="row">
			<h1 class="display-1 text-warning text-center">ESTANCO VIRTUAL</h1>
		</div>

		<div class="row">
			<p class="lead text-warning text-center">Bienvenido a tu estanco de confianza desde casa</p>
		<div>
	</header>


	<div class="container py-5">


		<div class="row">

			<h3 class="display-3 text-secondary text-center">IDENTIFICATE</h3>

		</div>

		<div class="row">

			<form id="login-form">
				<fieldset>
				  <div class="form-group">
				    <label for="userName">Indica tu nombre de usuario</label>
					<input class="form-control" id="userName" type="text" minlength="5" title="Indica tu nombre de usuario" required >
				  </div>

				   <div class="form-group">
				    <label for="password">Indica la contraseña:</label>
				    <input class="form-control" id="password"  type="password" minlength="5" maxlength="15" title="Indica tu constraseña" required>
				  </div>

				   <div class="form-group mt-5">
				  	<div class="row">
				  		<button type="submit" class="btn btn-outline-warning btn-lg btn-block" id="enviar">Login!</button>
				  	</div>
				  </div>

				</fieldset>
			</form>
		</div>

		<div class="row mt-4">

			<a class="lead text-center link-secondary" href="register.html"> Todavía no estas registrado? Pincha aquí</a>
		</div>

	</div>

	<div class="container">

		<div class="row py-5 justify-content-center" style="display: none" id="container-hidden">
			<p class="lead text-warning text-center">CARGANDO...</p>
			<a name="GIF"></a>
		</div>

		<div class="row py-5 justify-content-center">
			
			<div class="col-6" id="contenido-dinamico">
			
			</div>
		</div>
	</div>

	<footer class="container-fluid estancoColors py-5 mt-5">

		<div class="container-fluid rounded border border-2 border-warning col-6">
			<p class="lead text-warning text-center">Derechos reservados</p>
		</div>

	</footer>

</body>

<script type="text/javascript">
	
	var userToSend={};
	var gif={};
	var userReceived={};

	function loginFunction(evento){

		evento.preventDefault();

		let userName= document.getElementById("userName").value;
		let password=document.getElementById("password").value;

		userToSend={userName:userName, password:password};


		fetch("http://localHost:8080/api/users/login",{

			method:"POST",
			headers:{
				"Content-Type":"application/json",
				"Accept": "application/json"
			},

			body:JSON.stringify(userToSend)

		})

		.then(function(response){
			if(response.ok){
				return response.json();
			}else{
				throw response;
			}
		})

		.then(function (r){
			userReceived=r;
			getGIF();

		})

		.catch(function(error){

			alert("No existe usuario: "+userName +" con la contraseña indicada");
		})

	}

	function getGIF(){


		fetch("http://localHost:8080/api/GIF",{

			method:"GET",
			headers:{
				"Content-Type":"application/json",
				"Accept":"application/json"
			}
		})

		.then(function(response){

			if(response.ok){
				return response.json();
			}else{
				throw response;
			}
		})

		.then(function(r){
			gif=r;
			showGIF(gif);
		})

		.catch(function(e){console.error(e)})
	}

	function storeUser(){
		//Muy importante guardar el User como JSON si no no va

		window.localStorage.setItem("activeUser",JSON.stringify(userReceived));
		console.log("Guardando al usuario en el localStorage");
	}

	function showGIF(gif){
		let containerForGIF=document.getElementById("contenido-dinamico");
		let containerHidden=document.getElementById("container-hidden");

		//Le quito el atributo hidden poniendole el style a vacio
		containerHidden.style="";

		containerForGIF.innerHTML="";
		containerForGIF.innerHTML=`<img src="${gif.contenido}" class="rounded mx-auto d-block">`

		//Para que vaya al GIF y no se quede arriba de la pagina 
		window.location.href="#GIF";

		//Provoco delay aposta para poder ver algo

		console.log("Inicia Espera...")
		window.setTimeout(function(){

			alert("Bienvenido: "+userReceived.userName);
			storeUser("UsuarioActivo", userReceived);
			window.location.href="home.html";
			console.log("Fin")
		}, 5000);



	}

	const formulario= document.getElementById("login-form");

	formulario.addEventListener("submit", loginFunction);

</script>
</html>